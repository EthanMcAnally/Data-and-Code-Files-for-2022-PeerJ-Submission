####Taxonomy aligned relative abundance data csv from Qiime2 imported to R
##WB = flow cell 1, FC = flow cell 2, R = rbcL, S = 18S

library(tidyverse)
library(ggplot2)
library(funrar)
library(dplyr)
library(readr)
library(reshape2)
library(vegan)
library(ggthemes)
library(extrafont)
library(scales)
library(ggpubr)
library(gridExtra)
library(rstatix) 
library(emmeans)
library(MASS)
library(pals)
library(Polychrome)

#imports non-genetic data on samples
sample_data <- read.csv("/Users/ethanmcanally/Documents/Fall 2022/Research/Data Files/sample_prep_data _WB-FC.csv") #import csv
barcoded <- sample_data[sample_data$barcode != 00,] #remove unbarcoded samples
R_sample_data <- barcoded[barcoded$primer == "rbcl",] #makes rbcl df
S_sample_data <- barcoded[barcoded$primer == "18s",] #makes 18s df
R_sample_data <- R_sample_data[order(R_sample_data$barcode),] #orders df by barcode number
S_sample_data <- S_sample_data[order(S_sample_data$barcode),] #orders df by barcode number

#imports data from WB run
WB_S_data <- read.csv("/Users/ethanmcanally/Documents/Fall 2022/Research/Data Files/tax_WB_S.csv") #import data
WB_S_sample_names <- WB_S_data[,1] #make a variable of sample_names for later use
WB_S_data <- WB_S_data[,-1] #remove column of sample names, so all values are numeric
wildcard <- "*Bacillariophyta*"
vector <- colnames(WB_S_data)
sum(WB_S_data)
keepers <- grep(wildcard, vector, value = TRUE)
WB_S_data <- WB_S_data[c(keepers)]
sum(WB_S_data)
vector <- character()
for (x in colnames(WB_S_data)) {
  x <- gsub(".", ";", x, fixed = TRUE)
  x <- gsub(";__", "", x, fixed = TRUE)
  x <- gsub(".*;", "", x,)
  vector <- c(vector,x)
}
colnames(WB_S_data) <- vector
WB_S_data <- data.matrix(WB_S_data) #convert to matrix (necessary for next step)
WB_S_data <- make_relative(WB_S_data) #convert to relative as opposed to numeric abundance
other <- WB_S_data
other[other > 0.01] <- 0
other <- rowSums(other)
WB_S_data[WB_S_data < 0.01] <- 0 #removes data on species composing less than 1.0% of a sample
WB_S_data <- cbind(WB_S_data,other)
WB_S_data <- make_relative(WB_S_data) #resets data to relative abundance (otherwise would not add to 100%)
WB_S_data <- as.data.frame(WB_S_data) #convert back to data frame (better for manipulation)
WB_S_data <- WB_S_data[, colSums(WB_S_data != 0) > 0]
WB_S_data<- cbind(WB_S_sample_names, WB_S_data) #puts column of sample_names back in
WB_S_data <- WB_S_data[order(WB_S_data$WB_S_sample_names),]#orders data by barcode number
WB_S_data <- cbind(S_sample_data, WB_S_data)#adds columns with non-genetic data
WB_S_data<- WB_S_data[,-12] #removes old sample names column
WB_S_data <- melt(WB_S_data, id.vars = 1:11, variable.name = "Phyla") #converts to long form for ggplotting
WB_S_data <- WB_S_data[WB_S_data$value != 0,] #removes taxa that are no longer in any sample (after 1% cutoff)
WB_S_data$barcode <- as.factor(WB_S_data$barcode)#assigns class of barcode column to factor for better figure
WB_S_data <- WB_S_data[order(WB_S_data$value),]#orders data by abundance for better looking figure

WB_R_data <- read.csv("/Users/ethanmcanally/Documents/Fall 2022/Research/Data Files/tax_WB_R.csv") #import data
WB_R_sample_names <- WB_R_data[,1] #make a variable of sample_names for later use
WB_R_data <- WB_R_data[,-1] #remove column of sample names, so all values are numeric
wildcard <- "*Bacillariophyta*"
vector <- colnames(WB_R_data)
sum(WB_R_data)
keepers <- grep(wildcard, vector, value = TRUE)
WB_R_data <- WB_R_data[c(keepers)]
sum(WB_R_data)
vector <- character()
for (x in colnames(WB_R_data)) {
  x <- gsub(".", ";", x, fixed = TRUE)
  x <- gsub(";__", "", x, fixed = TRUE)
  x <- gsub(".*;", "", x,)
  vector <- c(vector,x)
}
colnames(WB_R_data) <- vector
WB_R_data <- data.matrix(WB_R_data) #convert to matrix (necessary for next step)
WB_R_data <- make_relative(WB_R_data) #convert to relative as opposed to numeric abundance
other <- WB_R_data
other[other > 0.01] <- 0
other <- rowSums(other)
WB_R_data[WB_R_data < 0.01] <- 0 #removes data on species composing less than 1.0% of a sample
WB_R_data <- cbind(WB_R_data,other)
WB_R_data <- make_relative(WB_R_data) #resets data to relative abundance (otherwise would not add to 100%)
WB_R_data <- as.data.frame(WB_R_data) #convert back to data frame (better for manipulation)
WB_R_data <- WB_R_data[, colSums(WB_R_data != 0) > 0]
WB_R_data<- cbind(WB_R_sample_names, WB_R_data) #puts column of sample_names back in
WB_R_data <- WB_R_data[order(WB_R_data$WB_R_sample_names),]#orders data by barcode number
WB_R_data <- cbind(R_sample_data, WB_R_data)#adds columns with non-genetic data
WB_R_data<- WB_R_data[,-12] #removes old sample names column
WB_R_data <- melt(WB_R_data, id.vars = 1:11, variable.name = "Phyla") #converts to long form for ggplotting
WB_R_data <- WB_R_data[WB_R_data$value != 0,] #removes taxa that are no longer in any sample (after 1% cutoff)
WB_R_data$barcode <- as.factor(WB_R_data$barcode)#assigns class of barcode column to factor for better figure
WB_R_data <- WB_R_data[order(WB_R_data$value),]#orders data by abundance for better looking figure

#same for FC data
FC_S_data <- read.csv("/Users/ethanmcanally/Documents/Fall 2022/Research/Data Files/tax_FC_S.csv") #import data
FC_S_sample_names <- FC_S_data[,1] #make a variable of sample_names for later use
FC_S_data <- FC_S_data[,-1] #remove column of sample names, so all values are numeric
wildcard <- "*Bacillariophyta*"
vector <- colnames(FC_S_data)
sum(FC_S_data)
keepers <- grep(wildcard, vector, value = TRUE)
FC_S_data <- FC_S_data[c(keepers)]
sum(FC_S_data)
vector <- character()
for (x in colnames(FC_S_data)) {
  x <- gsub(".", ";", x, fixed = TRUE)
  x <- gsub(";__", "", x, fixed = TRUE)
  x <- gsub(".*;", "", x,)
  vector <- c(vector,x)
}
colnames(FC_S_data) <- vector
FC_S_data <- data.matrix(FC_S_data) #convert to matrix (necessary for next step)
FC_S_data <- make_relative(FC_S_data) #convert to relative as opposed to numeric abundance
FC_S_data[FC_S_data < 0.01] <- 0 #removes data on species composing less than 1.0% of a sample
FC_S_data <- make_relative(FC_S_data) #resets data to relative abundance (otherwise would not add to 100%)
FC_S_data <- as.data.frame(FC_S_data) #convert back to data frame (better for manipulation)
FC_S_data <- FC_S_data[, colSums(FC_S_data != 0) > 0]
FC_S_data<- cbind(FC_S_sample_names, FC_S_data) #puts column of sample_names back in
FC_S_data <- FC_S_data[order(FC_S_data$FC_S_sample_names),]#orders data by barcode number
FC_S_data <- cbind(S_sample_data, FC_S_data)#adds columns with non-genetic data
FC_S_data <- melt(FC_S_data, id.vars = 1:12, variable.name = "Phyla") #converts to long form for ggplotting
FC_S_data <- FC_S_data[FC_S_data$value != 0,] #removes taxa that are no longer in any sample (after 1% cutoff)
FC_S_data<- FC_S_data[,-12] #removes old sample names column
FC_S_data$barcode <- as.factor(FC_S_data$barcode)#assigns class of barcode column to factor for better figure
FC_S_data <- FC_S_data[order(FC_S_data$value),]#orders data by abundance for better looking figure

FC_R_data <- read.csv("/Users/ethanmcanally/Documents/Fall 2022/Research/Data Files/tax_FC_R.csv") #import data
FC_R_sample_names <- FC_R_data[,1] #make a variable of sample_names for later use
FC_R_data <- FC_R_data[,-1] #remove column of sample names, so all values are numeric
wildcard <- "*Bacillariophyta*"
vector <- colnames(FC_R_data)
sum(FC_R_data)
keepers <- grep(wildcard, vector, value = TRUE)
FC_R_data <- FC_R_data[c(keepers)]
sum(FC_R_data)
vector <- character()
for (x in colnames(FC_R_data)) {
  x <- gsub(".", ";", x, fixed = TRUE)
  x <- gsub(";__", "", x, fixed = TRUE)
  x <- gsub(".*;", "", x,)
  vector <- c(vector,x)
}
colnames(FC_R_data) <- vector
FC_R_data <- data.matrix(FC_R_data) #convert to matrix (necessary for next step)
FC_R_data <- make_relative(FC_R_data) #convert to relative as opposed to numeric abundance
FC_R_data[FC_R_data < 0.01] <- 0 #removes data on species composing less than 1.0% of a sample
FC_R_data <- make_relative(FC_R_data) #resets data to relative abundance (otherwise would not add to 100%)
FC_R_data <- as.data.frame(FC_R_data) #convert back to data frame (better for manipulation)
FC_R_data <- FC_R_data[, colSums(FC_R_data != 0) > 0]
FC_R_data<- cbind(FC_R_sample_names, FC_R_data) #puts column of sample_names back in
FC_R_data <- FC_R_data[order(FC_R_data$FC_R_sample_names),]#orders data by barcode number
FC_R_data <- cbind(R_sample_data, FC_R_data)#adds columns with non-genetic data
FC_R_data <- melt(FC_R_data, id.vars = 1:12, variable.name = "Phyla") #converts to long form for ggplotting
FC_R_data <- FC_R_data[FC_R_data$value != 0,] #removes taxa that are no longer in any sample (after 1% cutoff)
FC_R_data<- FC_R_data[,-12] #removes old sample names column
FC_R_data$barcode <- as.factor(FC_R_data$barcode)#assigns class of barcode column to factor for better figure
FC_R_data <- FC_R_data[order(FC_R_data$value),]#orders data by abundance for better looking figure
